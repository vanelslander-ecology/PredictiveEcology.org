{
  "hash": "6a8a40430b2c9862bf62d289f54478e2",
  "result": {
    "engine": "knitr",
    "markdown": "# Castor workflow with `setupProject`\n\n\n\n\n\n[Castor](https://github.com/bcgov/castor) is a forest and land-use model\nused to simulate forest harvest and its effects on multiple forest\nvalues, which include not only timber, but also habitat for several\nwildlife (e.g. caribou, fisher). It is a fully open-source model,\nimplemented in `SpaDES`, developed and maintained by researchers at the\nForest Analysis and Inventory Branch, BC Ministry of Forests.\n\nIn this chapter, we demonstrate how to set up a Castor workflow using\n`setupProject` from the\n[`SpaDES.project`](https://spades-project.predictiveecology.org/)\npackage. The code was adapted from [this Castor\nscenario](https://github.com/bcgov/castor/blob/main/R/scenarios/comparison_stsm/base_case_harvest_flow_20230628.Rmd),\nwith some modifications to streamline the code and accommodate the use of\n`SpaDES.project` functions[^castorexample-1].\n\nA bare-bones version of this example is also available in this [.R script ](https://github.com/PredictiveEcology/PredictiveEcology.org/blob/training-book/tutos/castorExample/castorExample.R)\n\n## Workflow setup\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## install/load necessary packages\nrepos <- c(\"predictiveecology.r-universe.dev\", getOption(\"repos\"))\ninstall.packages(c(\"remotes\", \"DiagrammeR\"), repos = repos)\nremotes::install_github(\"PredictiveEcology/SpaDES.project@transition\")   ## to deal with modules in nested GH folders.\nlibrary(SpaDES.project)\n\n## get Castor modules\nsetupFunctions(paths = list(\"projectPath\" = \"~/\"),\n               functions = c(\"PredictiveEcology/PredictiveEcology.org@training-book/tutos/castorExample/getCastorModulesAndDB.R\",\n                             \"PredictiveEcology/PredictiveEcology.org@training-book/tutos/castorExample/params.R\"),\n               overwrite = TRUE)\noutMod <- getCastorModulesAndDB(paths = list(\"modulePath\" = \"~/tutos/castorExample/modules/\",\n                                             \"projectPath\" = \"~/tutos/castorExample\"),\n                                modules = c(\"dataCastor\", \n                                            \"growingStockCastor\", \n                                            \"forestryCastor\", \n                                            \"blockingCastor\"),\n                                dbURL = \"https://drive.google.com/file/d/1-2POunzC7aFbkKK5LeBJNsFYMBBY8dNx/view?usp=sharing\",\n                                dbPath = \"R/scenarios/comparison_stsm\")\n\n## set up the workflow paths, dependencies and modules\n## as well as simulation parameters, (some) inputs and outputs\nout <- setupProject(\n  paths = list(\"inputPath\" = \"modules/forestryCastor/inputs\",\n               \"outputPath\" = \"/R/scenarios/comparison_stsm/outputs\",\n               \"modulePath\" = \"modules/\",\n               \"cachePath\" = \"modules/forestryCastor\",\n               \"projectPath\" = \"~/tutos/castorExample\"),\n  modules = names(outMod$modules),\n  functions = \"bcgov/castor@main/R/functions/R_Postgres.R\",\n  ## install and load\n  require = \"dplyr\",\n  ## install but don't load these:\n  packages = c(\n    \"DBI\", \n    \"keyring\",\n    \"rgdal\", \n    \"RPostgreSQL\", \n    \"sp\",\n    \"terra\"\n  ),\n  params = \"params.R\",\n  times = list(start = 0, end = 20),\n  outputs = {\n    data.frame(objectName = c(\"harvestReport\",\n                              \"growingStockReport\"))\n  },\n  scenario = {\n    data.table(name = \"stsm_base_case\",\n               description = paste(\"Priority queue = oldest first. Adjacency constraint\",\n                                   \"= None. Includes roads (mst) and blocks (pre).\",\n                                   \"Harvest flow = 147,300 m3/year in decade 1, 133,500\",\n                                   \"m3/year in decade 2, 132,300 m3/year in decades 3 to\",\n                                   \"14 and 135,400 m3/year in decades 15 to 25.\",\n                                   \"Minimum harvest age = 80 and minimum harvest volume = 150\"))\n  },\n  harvestFlow = {\n    rbindlist(list(data.table(compartment = \"tsa99\",\n                              partition = ' age > 79 AND vol > 149 ', \n                              period = rep( seq (from = 1,\n                                                 to = 1, \n                                                 by = 1),\n                                            1), \n                              flow = 1473000, \n                              partition_type = 'live'),\n                   data.table(compartment = \"tsa99\",\n                              partition = ' age > 79 AND vol > 149 ', \n                              period = rep( seq (from = 2,\n                                                 to = 2, \n                                                 by = 1),\n                                            1), \n                              flow = 1335000, \n                              partition_type = 'live'),\n                   data.table(compartment = \"tsa99\",\n                              partition = ' age > 79 AND vol > 149 ', \n                              period = rep( seq (from = 3,\n                                                 to = 14, \n                                                 by = 1),\n                                            1), \n                              flow = 1323000, \n                              partition_type = 'live'),\n                   data.table(compartment = \"tsa99\",\n                              partition = ' age > 79 AND vol > 149 ', \n                              period = rep( seq (from = 15,\n                                                 to = 25, \n                                                 by = 1),\n                                            1), \n                              flow = 1354000, \n                              partition_type = 'live')  \n    ))\n  },\n  Restart = TRUE\n)\n```\n:::\n\n\n\n## Initialise the model and inspect `simList`\n\n`setupProject()` returns a names list containing values that can be passed to\n`simInit()` arguments. \n\nWe use `do.call()` to pass the whole list of arguments to `simInit`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## initialize simulation\ncastorInit <- do.call(SpaDES.core::simInit, out)\n```\n:::\n\n\nAnother (more verbose) option would to call `simInit` directly:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## initialize simulation\ncastorInit <- SpaDES.core::simInit(\n  times = out$times,\n  params = out$params, \n  modules = out$modules, \n  objects = list(scenario = out$scenario, \n                 harvestFlow = out$harvestFlow)\n)\n```\n:::\n\n\n\nUse the following functions to access workflow/model properties. `events()`, for\ninstance will output the scheduled events, which at this point are only the `init`\nevents of each module as you can see in the output below.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## inspect the `simList`\nSpaDES.core::params(castorInit) \nSpaDES.core::inputs(castorInit)\nSpaDES.core::outputs(castorInit)\nSpaDES.core::times(castorInit) \n\n## scheduled events\nSpaDES.core::events(castorInit) \n```\n:::\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n\n```\n   eventTime         moduleName eventType eventPriority\n       <num>             <char>    <char>         <num>\n1:         0         checkpoint      init             0\n2:         0               save      init             0\n3:         0           progress      init             0\n4:         0               load      init             0\n5:         0         dataCastor      init             1\n6:         0 growingStockCastor      init             1\n7:         0     blockingCastor      init             1\n8:         0     forestryCastor      init             1\n```\n\n\n:::\n:::\n\n\n## Visualize the workflow\n\n`moduleDiagram()` and `objectDiagram()` are great to visualise how each module\ninteracts with the other. Recall that these interactions arise from object \"exchanges\"\nbetween modules, which are deduced by `simInit()` from module metadata (@fig-objectDiagram)\n-- i.e., if a module's inputs are another's outputs, then the first module will follow the second.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nSpaDES.core::moduleDiagram(castorInit)\nSpaDES.core::objectDiagram(castorInit)\n```\n:::\n\n::: {.cell}\n::: {.cell-output-display}\n![Diagram of module connections.](castorExample_files/figure-html/fig-moduleDiagram-1.png){#fig-moduleDiagram width=576}\n:::\n:::\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![Diagram of module inter-dependencies with object names.](assets/img/castorExample_objDiagram.png){#fig-objectDiagram fig-align='center'}\n:::\n:::\n\n\n## Run simulation\n\n`spades()` runs the simulation, beginning with the execution of the `init` events.\nNotice how the result of `outputs()` differs from previously.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncastorSim <- SpaDES.core::spades(castorInit)\n\n## we now have outputs\nSpaDES.core::outputs(castorSim)\n```\n:::\n\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n\n```\n          objectName\n1      harvestReport\n2 growingStockReport\n                                                                  file     fun\n1      C:/R/scenarios/comparison_stsm/outputs/harvestReport_year20.rds saveRDS\n2 C:/R/scenarios/comparison_stsm/outputs/growingStockReport_year20.rds saveRDS\n  package saveTime saved arguments\n1    base       20  TRUE        NA\n2    base       20  TRUE        NA\n```\n\n\n:::\n:::\n\n\n`completed(castorSim)` shows the chaining of events that was produced and run by `spades()`.\nThe sequence of steps in the workflow therefore arises from each module's events \nand their scheduling, rather than being explicitly imposed by the user.\n\n\n::: {.cell outlines='10'}\n\n```{.r .cell-code}\nSpaDES.core::completed(castorSim)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n    eventTime         moduleName          eventType eventPriority\n        <num>             <char>             <char>         <num>\n 1:         0         checkpoint               init             0\n 2:         0               save               init             0\n 3:         0           progress               init             0\n 4:         0               load               init             0\n 5:         0         dataCastor               init             1\n 6:         0 growingStockCastor               init             1\n 7:         0     blockingCastor               init             1\n 8:         0     forestryCastor               init             1\n....\n```\n\n\n:::\n:::\n\n\nWe suggest omitting the  `blockingCastor` module in `setupProject()` and rerunning\nthe workflow again to see how `spades` is capable of re-generating a new workflow with \nlittle effort from the user. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodules <- c(\"dataCastor\", \n             \"growingStockCastor\", \n             \"forestryCastor\")\n\nout <- setupProject(\n  paths = list(\"inputPath\" = \"modules/forestryCastor/inputs\",\n               \"outputPath\" = \"/R/scenarios/comparison_stsm/outputs\",\n               \"modulePath\" = \"modules/\",\n               \"cachePath\" = \"modules/forestryCastor\",\n               \"projectPath\" = \"~/tutos/castorExample/\"),\n  modules = modules,\n  functions = \"bcgov/castor@main/R/functions/R_Postgres.R\",\n  ## install and load\n  require = \"dplyr\",\n  ## install but don't load these:\n  packages = c(\n    \"DBI\", \n    \"keyring\",\n    \"rgdal\", \n    \"RPostgreSQL\", \n    \"sp\",\n    \"terra\"\n  ),\n  params = \"params.R\",\n  times = list(start = 0, end = 20),\n  outputs = {\n    data.frame(objectName = c(\"harvestReport\",\n                              \"growingStockReport\"))\n  },\n  scenario = {\n    data.table(name = \"stsm_base_case\",\n               description = paste(\"Priority queue = oldest first. Adjacency constraint\",\n                                   \"= None. Includes roads (mst) and blocks (pre).\",\n                                   \"Harvest flow = 147,300 m3/year in decade 1, 133,500\",\n                                   \"m3/year in decade 2, 132,300 m3/year in decades 3 to\",\n                                   \"14 and 135,400 m3/year in decades 15 to 25.\",\n                                   \"Minimum harvest age = 80 and minimum harvest volume = 150\"))\n  },\n  harvestFlow = {\n    rbindlist(list(data.table(compartment = \"tsa99\",\n                              partition = ' age > 79 AND vol > 149 ', \n                              period = rep( seq (from = 1,\n                                                 to = 1, \n                                                 by = 1),\n                                            1), \n                              flow = 1473000, \n                              partition_type = 'live'),\n                   data.table(compartment = \"tsa99\",\n                              partition = ' age > 79 AND vol > 149 ', \n                              period = rep( seq (from = 2,\n                                                 to = 2, \n                                                 by = 1),\n                                            1), \n                              flow = 1335000, \n                              partition_type = 'live'),\n                   data.table(compartment = \"tsa99\",\n                              partition = ' age > 79 AND vol > 149 ', \n                              period = rep( seq (from = 3,\n                                                 to = 14, \n                                                 by = 1),\n                                            1), \n                              flow = 1323000, \n                              partition_type = 'live'),\n                   data.table(compartment = \"tsa99\",\n                              partition = ' age > 79 AND vol > 149 ', \n                              period = rep( seq (from = 15,\n                                                 to = 25, \n                                                 by = 1),\n                                            1), \n                              flow = 1354000, \n                              partition_type = 'live')  \n    ))\n  },\n  Restart = TRUE\n)\n\n## initialize and run simulation in one go\ncastorSim2 <- do.call(SpaDES.core::simInitAndSpades, out)\n```\n:::\n\n\n[^castorexample-1]: `SpaDES.project` is currently being adapted to deal\nwith modules nested in folders of GitHub repositories (instead of\nliving in their own GitHub repositories), as is the case of Castor\nmodules. Hence, the code in this example is subject to changes in\nthe near future.\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}